#!/bin/bash -e

source $OPENSHIFT_CARTRIDGE_SDK_BASH


# create directories used by buildpack
mkdir -p $OPENSHIFT_LIBERTY_DROPLET_DIR
mkdir -p $OPENSHIFT_LIBERTY_CACHE_DIR
mkdir -p $OPENSHIFT_LIBERTY_LOG_DIR

# create files used by cartridge
touch $OPENSHIFT_LIBERTY_DIR/.app
touch $OPENSHIFT_LIBERTY_DIR/.services

# download buildpack if it's not packaged as part of cartridge
if [ ! -d "$OPENSHIFT_LIBERTY_BUILDPACK_DIR" ]
then
  client_message "downloading buildpack"
  git clone https://github.com/cloudfoundry/ibm-websphere-liberty-buildpack.git $OPENSHIFT_LIBERTY_BUILDPACK_DIR
fi

# deploy template app (WAR deploy but WAR is already extracted)
sed -i "s/{APP_NAME}/$OPENSHIFT_APP_NAME/g" $OPENSHIFT_LIBERTY_DIR/template/pom.xml
cp -R $OPENSHIFT_LIBERTY_DIR/template/src/main/webapp/* $OPENSHIFT_LIBERTY_DROPLET_DIR

# update ruby version so buildpack runs
curl https://raw.github.com/gist/3342482/ded2a7c542e150807287617736e6faf0ec395256/rbenv-openshift.sh | bash
